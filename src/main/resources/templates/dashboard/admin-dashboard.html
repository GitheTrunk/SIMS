<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SIMS</title>

    <!-- Styles -->
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #7c3aed;
            --bg: #f9fafb;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --danger: #ef4444;
            --success: #16a34a;
            --warning: #facc15;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
        }

        a {
            text-decoration: none;
        }

        /* SIDEBAR layout */
        .app {
            display: flex;
            min-height: 100vh;
            background-color: #0b1220;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #0b1220 0%, rgba(10,25,45,1) 100%);
            color: #cbd5e1;
            padding: 28px 20px;
            box-shadow: 6px 0 20px rgba(2,6,23,0.6);
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar .brand {
            display: flex;
            gap: 12px;
            align-items: center;
            color: white;
        }

        .sidebar .brand .title {
            font-weight: 800;
            font-size: 1.15rem;
            line-height: 1;
        }

        .sidebar .menu {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-top: 8px;
        }

        .sidebar .menu a {
            color: #9fb0c8;
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar .menu a.active {
            background: linear-gradient(90deg, rgba(37,99,235,0.12), rgba(124,58,237,0.08));
            color: white;
            box-shadow: 0 8px 20px rgba(3,7,18,0.3) inset;
        }

        .sidebar .status-card {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 12px;
            color: #cfe8ff;
            margin-top: auto;
        }

        .main {
            margin-left: 260px;
            flex: 1;
        }

        /* Header */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px;
        }

        .header-left h1 {
            margin: 0;
            font-size: 2.2rem;
            color: #e6eef9;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .header-left p {
            margin: 6px 0 0 0;
            color: #9fb0c8;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notif {
            background: rgba(255,255,255,0.04);
            padding: 10px 12px;
            border-radius: 12px;
            color: #ffd166;
            font-weight: 700;
        }

        .profile-badge {
            background: linear-gradient(90deg,#6d28d9,#2563eb);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Card look for stats */
        .stat {
            background: linear-gradient(180deg, rgba(12,18,28,0.85), rgba(8,14,22,0.9));
            color: #e6eef9;
            padding: 28px;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
            border-left: none;
            position: relative;
            overflow: hidden;
        }

        .stat h3 { color: #9fb0c8; margin:0 0 8px 0; font-weight:600; }
        .stat .stat-value { color: #ffffff; font-size:2.8rem; }

        .stat .card-icon {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.04);
            font-size: 1.6rem;
        }

        .stat .meta { margin-top: 18px; color: #9fb0c8; display:flex; gap:10px; align-items:center; }

        .pill { background: #0f766e; color: #d1fae5; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.85rem; }


        /* MAIN */
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 32px;
        }

        h1 {
            font-size: 2.4rem;
            margin-bottom: 6px;
        }

        h2 {
            font-size: 2rem;
            margin: 48px 0 24px;
            border-bottom: 4px solid var(--primary);
            display: inline-block;
            padding-bottom: 6px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-gray);
        }

        /* STATS */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
            margin: 40px 0;
        }

        .stat {
            background: linear-gradient(180deg, #0b1220 0%, rgba(10,25,45,1) 100%);
            padding: 24px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .stat h3 {
            text-transform: uppercase;
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .stat-value {
            font-size: 2.4rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* TABLE */
        .table-box {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        th, td {
            padding: 14px 18px;
            text-align: left;
        }

        tbody tr:hover {
            background: #f3f4f6;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: var(--success);
        }

        .badge-warning {
            background: #fef9c3;
            color: #92400e;
        }

        /* BUTTONS */
        .btn {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .btn-green {
            background: var(--success);
            color: white;
        }

        .btn-red {
            background: var(--danger);
            color: white;
        }

        .btn-gray {
            background: #e5e7eb;
            color: #111827;
        }

        .btn-gray:hover {
            background: #d1d5db;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* STATUS GRID */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }

        .status-card h4 {
            color: var(--primary);
            margin-bottom: 6px;
        }

        /* QUICK ACTIONS */
                

                /* Extracted dashboard styles from index files */
                body { box-sizing: border-box; }

                @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap');

                * { font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; }

                @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
                @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
                @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }

                .stat-card { animation: slideInUp 0.6s ease-out forwards; opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
                .stat-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
                .stat-card:hover::before { left: 100%; }
                .stat-card:nth-child(1) { animation-delay: 0.1s; }
                .stat-card:nth-child(2) { animation-delay: 0.2s; }
                .stat-card:nth-child(3) { animation-delay: 0.3s; }
                .stat-card:nth-child(4) { animation-delay: 0.4s; }
                .stat-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); }

                .nav-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
                .nav-item::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 3px; background-color: transparent; transition: all 0.3s ease; }
                .nav-item:hover::before { background-color: currentColor; }
                .nav-item:hover { transform: translateX(8px); padding-left: 28px; }
                .nav-item.active { font-weight: 600; }

                .chart-bar { transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); animation: growUp 1s ease-out forwards; transform-origin: bottom; }
                @keyframes growUp { from { transform: scaleY(0); opacity: 0; } to { transform: scaleY(1); opacity: 1; } }
                .chart-bar:hover { opacity: 0.8; transform: scaleY(1.05); }

                .action-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
                .action-btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
                .action-btn:hover::after { width: 300px; height: 300px; }
                .action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }

                .activity-item { animation: slideInLeft 0.5s ease-out forwards; opacity: 0; transition: all 0.3s ease; }
                .activity-item:nth-child(1) { animation-delay: 0.5s; }
                .activity-item:nth-child(2) { animation-delay: 0.6s; }
                .activity-item:nth-child(3) { animation-delay: 0.7s; }
                .activity-item:hover { transform: translateX(8px); background-color: rgba(59, 130, 246, 0.05); }

                .icon-wrapper { transition: all 0.3s ease; }
                .stat-card:hover .icon-wrapper { transform: scale(1.2) rotate(5deg); }

                .gradient-border { position: relative; border: 2px solid transparent; background-clip: padding-box; }
                .gradient-border::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899); border-radius: inherit; z-index: -1; opacity: 0; transition: opacity 0.3s; }
                .gradient-border:hover::before { opacity: 1; }

                .header-section { animation: fadeIn 0.8s ease-out; }
                .pulse-dot { animation: pulse 2s infinite; }

                @media (max-width: 768px) {
                    .sidebar { width: 240px; }
                    .main-content { margin-left: 240px; }
                }

                /* Extra animations and micro-interactions */
                @keyframes badgeBounce { 0% { transform: translateY(0) scale(1); } 30% { transform: translateY(-6px) scale(1.05); } 60% { transform: translateY(0) scale(0.98); } 100% { transform: translateY(0) scale(1); } }
                @keyframes floatSubtle { 0% { transform: translateY(0); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0); } }
                .sidebar { animation: slideInLeft 0.6s cubic-bezier(.22,.9,.3,1) forwards; opacity: 0; }
                .main-content { animation: fadeIn 0.6s cubic-bezier(.22,.9,.3,1) 0.12s forwards; opacity: 0; }
                .notification-badge-anim { animation: badgeBounce 1s ease-in-out; }
                .stat-value { display: inline-block; min-width: 48px; }
                .stat-value.shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.08), rgba(255,255,255,0.03)); background-size: 200% 100%; animation: shimmer 1.6s linear infinite; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                .action-btn[data-ripple] { position: relative; overflow: hidden; }
                .ripple-elem { position: absolute; border-radius: 50%; transform: scale(0); background: rgba(255,255,255,0.18); animation: ripple 0.6s ease-out forwards; pointer-events: none; }
                @keyframes ripple { to { transform: scale(6); opacity: 0; } }

                @media (prefers-reduced-motion: reduce) {
                    .sidebar, .main-content, .stat-card, .activity-item, .chart-bar, .header-section { animation: none !important; transition: none !important; }
                    .stat-card::before, .action-btn::after { transition: none !important; }
                }
    </style>
</head>

<body>

<!-- APP LAYOUT -->
<div class="app">
    <aside class="sidebar">
        <div class="brand">
            <div style="font-size:28px;">üìö</div>
            <div>
                <div class="title">SIMS Admin</div>
                <div style="font-size:0.8rem; color:#90a4bf;">Dashboard</div>
            </div>
        </div>

        <div class="menu">
            <a href="/admin/dashboard" class="nav-item active">Overview</a>
            
            
        </div>

        <div class="status-card" id="sidebarStatusCard" style="cursor:pointer;">
            <div style="display:flex; gap:12px; align-items:center;">
                <div id="sidebarStatusDot" style="width:12px;height:12px;border-radius:50%;background:#10b981;box-shadow:0 0 8px rgba(16,185,129,0.18)"></div>
                <div style="flex:1;">
                    <div style="font-weight:700;color:#e6eef9;">System Status</div>
                    <div id="sidebarStatusText" style="font-size:0.85rem;color:#bcd8ff;margin-top:6px;">All systems operational</div>
                </div>
                <div style="font-size:0.85rem;color:#9fb0c8;">View</div>
            </div>
        </div>

        <div class="stat stat-card">
            <a href="/auth/logout">Logout</a>
        </div>
    </aside>

    <main class="main main-content">

<!-- MAIN -->
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Welcome back, Administrator</h1>
            <p class="subtitle">Here's what's happening with your system today ‚ú®</p>
        </div>

        <div class="header-actions">
            

            <!-- Live logins badge -->
            <div id="liveLogins" style="position:relative;">
                <div id="liveLoginsBadge" class="notif" style="cursor:pointer;margin-left:8px; display:flex; align-items:center; gap:8px;">
                    üîî <span id="liveLoginsCount">0</span>
                    <span style="font-size:0.78rem; color:#cfe8ff; margin-left:6px; opacity:0.9;">(S: <span id="studentLoginsCount">0</span> C: <span id="companyLoginsCount">0</span>)</span>
                </div>
                <div id="liveLoginsContainer" style="display:none; position:absolute; right:0; top:48px; width:360px; background:#071226; color:#cfe8ff; border-radius:8px; padding:8px; box-shadow:0 10px 30px rgba(2,6,23,0.6); z-index:1000; max-height:360px; overflow:auto; font-size:0.95rem;"></div>
            </div>
            
            <!-- Admin profile (click to open profile modal) -->
            <div id="adminProfile" style="margin-left:12px; display:flex; align-items:center; gap:10px; cursor:pointer;">
                <div class="profile-badge" id="adminProfileBadge" style="padding:8px 10px;">
                    <div id="adminAvatar" style="width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#6d28d9,#2563eb);color:white;font-weight:700;margin-right:8px;">A</div>
                    <div style="display:inline-block;text-align:left;font-size:0.95rem;">
                        <div id="adminName" style="font-weight:700;color:#fff;">Administrator</div>
                        <div id="adminRole" style="font-size:0.78rem;color:#cfe8ff;opacity:0.9">Admin</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats">
        <div class="stat stat-card" id="totalStudentsCard" style="cursor:pointer;">
            <h3>TOTAL STUDENTS</h3>
            <div id="totalStudentsValue" class="stat-value" th:text="${totalStudents}">0</div>
            <div class="card-icon">üéì</div>
            <div class="meta"><div class="pill">‚Üë 12%</div><div>from last month</div></div>
        </div>

        <div class="stat stat-card" id="totalInternshipsCard" style="cursor:pointer;">
            <h3>TOTAL INTERNSHIPS</h3>
            <div id="totalInternshipsValue" class="stat-value" th:text="${totalInternships}">0</div>
            <div class="card-icon">üìö</div>
            <div class="meta"><div class="pill">‚Üë 5%</div><div>from last month</div></div>
        </div>

        <div class="stat stat-card" id="totalCompaniesCard" style="cursor:pointer;">
            <h3>TOTAL COMPANIES</h3>
            <div id="totalCompaniesValue" class="stat-value" th:text="${totalCompanies}">0</div>
            <div class="card-icon">üè¢</div>
            <div class="meta"><div class="pill">‚Üí 0%</div><div>from last month</div></div>
        </div>

        <div class="stat stat-card" id="pendingRequestsCard" style="cursor:pointer;">
            <h3>PENDING REQUESTS</h3>
            <div id="pendingRequestsValue" class="stat-value" th:text="${pendingApplications}">0</div>
            <div class="card-icon">‚è≥</div>
            <div class="meta"><div class="pill" style="background:#b91c1c;">‚ö† Urgent</div><div>requires attention</div></div>
        </div>
    </div>

    <!-- expanded students list (hidden by default) -->
    <div id="studentsListContainer" style="display:none;margin-top:18px;max-width:1200px;margin-left:auto;margin-right:auto"></div>
    <div id="companiesListContainer" style="display:none;margin-top:18px;max-width:1200px;margin-left:auto;margin-right:auto"></div>
    <div id="internshipsListContainer" style="display:none;margin-top:18px;max-width:1200px;margin-left:auto;margin-right:auto"></div>
    <div id="pendingRequestsListContainer" style="display:none;margin-top:18px;max-width:1200px;margin-left:auto;margin-right:auto"></div>

   
    

    <!-- SYSTEM STATUS -->
    

    <!-- ACTIONS -->
    
    
    </div>
    </main>
</div>

<!-- SCRIPT -->


<script>
    // Handle back/forward navigation to load fragments when user navigates history
    window.addEventListener('popstate', function(){
        const path = location.pathname || '';
        const container = document.querySelector('.main .container');
        if(!container) return;
        if(path.startsWith('/admin/manage-internships')){
            fetch('/admin/manage-internships/fragment').then(r=>{ if(!r.ok) throw new Error('Network'); return r.text(); }).then(html=>{ container.innerHTML = html; if(window.initManageInternshipsFragment) window.initManageInternshipsFragment(); });
            document.querySelectorAll('.sidebar .menu .nav-item').forEach(n=>n.classList.remove('active'));
            const l = document.getElementById('link-manage-internships'); if(l) l.classList.add('active');
        } else if(path.startsWith('/admin/view-users')){
            fetch('/admin/view-users/fragment').then(r=>{ if(!r.ok) throw new Error('Network'); return r.text(); }).then(html=>{ container.innerHTML = html; if(window.initViewUsersFragment) window.initViewUsersFragment(); });
            document.querySelectorAll('.sidebar .menu .nav-item').forEach(n=>n.classList.remove('active'));
            const l = document.getElementById('link-view-users'); if(l) l.classList.add('active');
        }
    });
</script>
<scrip>
<div id="systemStatusBackdrop" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);backdrop-filter:blur(6px);z-index:2000;align-items:center;justify-content:center;">
    <div style="max-width:520px;width:92%;margin:auto;padding:18px;">
        <div class="status-panel" role="dialog" aria-modal="true" style="background:#071226;padding:18px;border-radius:12px;color:#cfe8ff;box-shadow:0 12px 40px rgba(2,6,23,0.6);">
            <div class="sp-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <div class="sp-title" style="font-size:1.05rem;font-weight:800;color:white">System Status</div>
                    <div class="sp-sub" style="font-size:0.85rem;color:#9fb0c8">Real-time monitoring</div>
                </div>
                <button class="sp-close" id="closeSystemStatus" style="background:transparent;border:0;color:#9fb0c8;font-size:18px;cursor:pointer;padding:6px 8px;border-radius:8px">‚úï</button>
            </div>

            <div class="sp-list" style="display:flex;flex-direction:column;gap:10px;">
                <div class="sp-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);">
                    <div class="sp-item-left" style="display:flex;gap:12px;align-items:center;">
                        <div class="dot" style="width:12px;height:12px;border-radius:50%;background:#10b981;box-shadow:0 0 8px rgba(16,185,129,0.2)"></div>
                        <div>
                            <div class="item-title" style="font-weight:700">Database</div>
                            <div class="item-meta" style="font-size:0.85rem;color:#9fb0c8">Uptime: <strong style="color:var(--primary)">99.9%</strong></div>
                        </div>
                    </div>
                    <div class="status-badge" style="background:#052a1d;color:#9fe9c9;padding:6px 10px;border-radius:999px;font-weight:700">Operational</div>
                </div>

                <div class="sp-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;">
                    <div class="sp-item-left" style="display:flex;gap:12px;align-items:center;">
                        <div class="dot" style="width:12px;height:12px;border-radius:50%;background:#10b981"></div>
                        <div>
                            <div class="item-title" style="font-weight:700">API Server</div>
                            <div class="item-meta" style="font-size:0.85rem;color:#9fb0c8">Uptime: <strong style="color:var(--primary)">99.8%</strong></div>
                        </div>
                    </div>
                    <div class="status-badge" style="background:#052a1d;color:#9fe9c9;padding:6px 10px;border-radius:999px;font-weight:700">Operational</div>
                </div>

                <div class="sp-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;">
                    <div class="sp-item-left" style="display:flex;gap:12px;align-items:center;">
                        <div class="dot" style="width:12px;height:12px;border-radius:50%;background:#10b981"></div>
                        <div>
                            <div class="item-title" style="font-weight:700">Authentication</div>
                            <div class="item-meta" style="font-size:0.85rem;color:#9fb0c8">Uptime: <strong style="color:var(--primary)">100%</strong></div>
                        </div>
                    </div>
                    <div class="status-badge" style="background:#052a1d;color:#9fe9c9;padding:6px 10px;border-radius:999px;font-weight:700">Operational</div>
                </div>

                <div class="sp-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;">
                    <div class="sp-item-left" style="display:flex;gap:12px;align-items:center;">
                        <div class="dot" style="width:12px;height:12px;border-radius:50%;background:#10b981"></div>
                        <div>
                            <div class="item-title" style="font-weight:700">File Storage</div>
                            <div class="item-meta" style="font-size:0.85rem;color:#9fb0c8">Uptime: <strong style="color:var(--primary)">99.7%</strong></div>
                        </div>
                    </div>
                    <div class="status-badge" style="background:#052a1d;color:#9fe9c9;padding:6px 10px;border-radius:999px;font-weight:700">Operational</div>
                </div>

                <div class="sp-item" style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;">
                    <div class="sp-item-left" style="display:flex;gap:12px;align-items:center;">
                        <div class="dot" style="width:12px;height:12px;border-radius:50%;background:#10b981"></div>
                        <div>
                            <div class="item-title" style="font-weight:700">Email Service</div>
                            <div class="item-meta" style="font-size:0.85rem;color:#9fb0c8">Uptime: <strong style="color:var(--primary)">98.5%</strong></div>
                        </div>
                    </div>
                    <div class="status-badge" style="background:#052a1d;color:#9fe9c9;padding:6px 10px;border-radius:999px;font-weight:700">Operational</div>
                </div>
            </div>

            <div class="sp-footer" style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;border-top:1px solid rgba(255,255,255,0.03);padding-top:12px;color:#9fb0c8;">
                <div style="display:flex;align-items:center;gap:10px;font-weight:700;color:#9fe9c9">‚úì All systems operational</div>
                <small>Last updated: <span id="systemStatusTime">--:--:--</span></small>
            </div>
        </div>
    </div>
</div>
</scrip>
<script>
    // Toggle system status modal
    (function(){
        const backdrop = document.getElementById('systemStatusBackdrop');
        const closeBtn = document.getElementById('closeSystemStatus');
        const sidebarStatus = document.querySelector('.sidebar .status-card');
        function openStatus(){
            if(!backdrop) return;
            backdrop.style.display = 'flex';
            const now = new Date();
            const fmt = now.toLocaleTimeString();
            const el = document.getElementById('systemStatusTime');
            if (el) el.textContent = fmt;
        }
        function closeStatus(){ if(backdrop) backdrop.style.display = 'none'; }
        if (sidebarStatus) sidebarStatus.addEventListener('click', openStatus);
        const openBtn = document.getElementById('openStatusModal');
        if (openBtn) openBtn.addEventListener('click', openStatus);
        if (closeBtn) closeBtn.addEventListener('click', closeStatus);
        if (backdrop) backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeStatus(); });
    })();
</script>

<script>
    // Expand/collapse internships list when clicking the Total Internships stat
    (function(){
        const card = document.getElementById('totalInternshipsCard');
        const container = document.getElementById('internshipsListContainer');
        if(!card || !container) return;
        let opened = false;
        async function fetchInternships(){
            try{
                const res = await fetch('/admin/api/internships');
                if(!res.ok) throw new Error('failed');
                const items = await res.json();
                return items || [];
            }catch(e){ console.error('Failed to fetch internships', e); return []; }
        }

        function renderInternships(list){
            container.innerHTML = '';
            if(!list || !list.length){
                container.innerHTML = '<div style="padding:22px;color:#9fb0c8;background:transparent;border-radius:8px;text-align:center">No internships found</div>';
                return;
            }
            const wrap = document.createElement('div');
            wrap.style.display = 'grid';
            wrap.style.gridTemplateColumns = '1fr';
            wrap.style.gap = '12px';
            list.forEach(it => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '12px 16px';
                row.style.borderRadius = '8px';
                row.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';

                const left = document.createElement('div');
                left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '12px'; left.style.flex = '1';
                const icon = document.createElement('div');
                icon.style.width='44px'; icon.style.height='44px'; icon.style.borderRadius='8px'; icon.style.display='flex'; icon.style.alignItems='center'; icon.style.justifyContent='center'; icon.style.color='#fff'; icon.style.fontWeight='800'; icon.style.background='linear-gradient(90deg,#7c3aed,#2563eb)';
                icon.textContent = (it.title||'').charAt(0).toUpperCase();
                const meta = document.createElement('div');
                const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.title || '';
                const sub = document.createElement('div'); sub.style.color='#9fb0c8'; sub.style.fontSize='0.95rem'; sub.textContent = (it.company? it.company : (it.department || '')) + (it.location ? (' ‚Ä¢ ' + it.location) : '');
                meta.appendChild(title); if(sub.textContent) meta.appendChild(sub);
                left.appendChild(icon); left.appendChild(meta);

                const right = document.createElement('div');
                right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';

                const apps = document.createElement('div'); apps.textContent = (it.applications || 0) + ' apps'; apps.style.color='#9fb0c8'; apps.style.fontWeight='700';
                const status = document.createElement('div'); status.textContent = it.status || 'ACTIVE'; status.style.padding='6px 10px'; status.style.borderRadius='8px'; status.style.background='rgba(255,255,255,0.03)';

                right.appendChild(apps); right.appendChild(status);

                row.appendChild(left); row.appendChild(right);
                wrap.appendChild(row);
            });
            container.appendChild(wrap);
        }

        card.addEventListener('click', async function(){
            if(opened){ container.style.display = 'none'; opened = false; return; }
            container.style.display = 'block';
            container.innerHTML = '<div style="padding:18px;color:#9fb0c8">Loading internships...</div>';
            const items = await fetchInternships();
            renderInternships(items);
            opened = true;
            container.scrollIntoView({behavior:'smooth'});
        });
    })();
</script>
</script>
</script>


<script>
    // Periodically fetch overview numbers and update stat cards
    (function(){
        async function refreshOverview(){
            try{
                const res = await fetch('/admin/api/overview');
                if(!res.ok) return;
                const data = await res.json();
                const ts = document.getElementById('totalStudentsValue');
                const ti = document.getElementById('totalInternshipsValue');
                const tc = document.getElementById('totalCompaniesValue');
                const pr = document.getElementById('pendingRequestsValue');
                if(ts && data.totalStudents !== undefined) ts.textContent = data.totalStudents;
                if(ti && data.totalInternships !== undefined) ti.textContent = data.totalInternships;
                if(tc && data.totalCompanies !== undefined) tc.textContent = data.totalCompanies;
                if(pr && data.pendingApplications !== undefined) pr.textContent = data.pendingApplications;
            }catch(e){ console.error('Overview refresh failed', e); }
        }
        // initial
        refreshOverview();
        setInterval(refreshOverview, 15000);
    })();
</script>


<script>
    // Load manage internships fragment into dashboard main area
    (function(){
        const link = document.getElementById('link-manage-internships');
        const container = document.querySelector('.main .container');
        if (!link || !container) return;
        link.addEventListener('click', function(e){
            e.preventDefault();
            fetch('/admin/manage-internships/fragment')
                .then(r => { if (!r.ok) throw new Error('Network error'); return r.text(); })
                .then(html => {
                    container.innerHTML = html;
                    if (window.initManageInternshipsFragment) window.initManageInternshipsFragment();
                    container.scrollIntoView({behavior:'smooth'});
                    document.querySelectorAll('.sidebar .menu .nav-item').forEach(n=>n.classList.remove('active'));
                    link.classList.add('active');
                    try { history.pushState({}, '', '/admin/manage-internships'); } catch(e){}
                })
                .catch(err=>{ console.error('Failed to load internships fragment', err); window.location.href = '/admin/manage-internships'; });
        });
    })();
</script>

<script>
    // Load view-users fragment into dashboard main area
    (function(){
        const link = document.getElementById('link-view-users');
        const container = document.querySelector('.main .container');
        if (!link || !container) return;
        link.addEventListener('click', function(e){
            e.preventDefault();
            fetch('/admin/view-users/fragment')
                .then(r => { if (!r.ok) throw new Error('Network error'); return r.text(); })
                .then(html => {
                    container.innerHTML = html;
                    if (window.initViewUsersFragment) window.initViewUsersFragment();
                    container.scrollIntoView({behavior:'smooth'});
                    document.querySelectorAll('.sidebar .menu .nav-item').forEach(n=>n.classList.remove('active'));
                    link.classList.add('active');
                    try { history.pushState({}, '', '/admin/view-users'); } catch(e){}
                })
                .catch(err=>{ console.error('Failed to load view-users fragment', err); window.location.href = '/admin/view-users'; });
        });
    })();
</script>

<script>
    // Expand/collapse student list when clicking the Total Students stat
    (function(){
        const card = document.getElementById('totalStudentsCard');
        const container = document.getElementById('studentsListContainer');
        if(!card || !container) return;
        let opened = false;
        async function fetchStudents(){
            try{
                const res = await fetch('/admin/api/users');
                if(!res.ok) throw new Error('failed');
                const users = await res.json();
                return (users||[]).filter(u => ((u.role||'').toString().toUpperCase() === 'STUDENT'));
            }catch(e){ console.error('Failed to fetch students', e); return []; }
        }

        function renderStudents(list){
            container.innerHTML = '';
            if(!list || !list.length){
                container.innerHTML = '<div style="padding:22px;color:#9fb0c8;background:transparent;border-radius:8px;text-align:center">No students found</div>';
                return;
            }
            const wrap = document.createElement('div');
            wrap.style.display = 'grid';
            wrap.style.gridTemplateColumns = '1fr';
            wrap.style.gap = '12px';
            list.forEach(u => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '12px 16px';
                row.style.borderRadius = '8px';
                row.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '12px';
                const avatar = document.createElement('div');
                avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='10px'; avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center'; avatar.style.color='#fff'; avatar.style.fontWeight='800'; avatar.style.background='linear-gradient(90deg,#7c3aed,#2563eb)';
                avatar.textContent = (u.username||'').charAt(0).toUpperCase();
                const meta = document.createElement('div');
                const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = u.username || '';
                const email = document.createElement('div'); email.style.color='#9fb0c8'; email.style.fontSize='0.95rem'; email.textContent = u.email || '';
                meta.appendChild(name); meta.appendChild(email);
                left.appendChild(avatar); left.appendChild(meta);

                const right = document.createElement('div');
                right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
                const role = document.createElement('div'); role.textContent = u.role || ''; role.style.padding='6px 10px'; role.style.borderRadius='8px'; role.style.background='rgba(255,255,255,0.03)'; role.style.fontWeight='700';
                const status = document.createElement('div'); status.textContent = u.active? 'Active' : 'Inactive'; status.style.color = u.active? '#9fe9c9' : '#cfe8ff';

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.style.padding = '8px 12px';
                editBtn.style.borderRadius = '8px';
                editBtn.style.border = 'none';
                editBtn.style.background = 'linear-gradient(90deg,#06b6d4,#3b82f6)';
                editBtn.style.color = '#071226';
                editBtn.style.cursor = 'pointer';

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.style.padding = '8px 12px';
                delBtn.style.borderRadius = '8px';
                delBtn.style.border = 'none';
                delBtn.style.background = 'linear-gradient(90deg,#ef4444,#fb7185)';
                delBtn.style.color = '#fff';
                delBtn.style.cursor = 'pointer';

                // Edit handler - simple prompt edit for name/email
                editBtn.addEventListener('click', async function(e){
                    e.stopPropagation();
                    const newName = prompt('Edit student name', u.username || '');
                    if(newName === null) return;
                    const newEmail = prompt('Edit student email', u.email || '');
                    if(newEmail === null) return;
                    try{
                        const res = await fetch('/admin/api/users/' + u.id, {
                            method: 'PUT',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({username: newName, email: newEmail})
                        });
                        if(!res.ok) throw new Error('update failed');
                        const updated = await res.json();
                        // update UI
                        name.textContent = updated.username || newName;
                        email.textContent = updated.email || newEmail;
                    }catch(err){ console.error('Failed to update user', err); alert('Failed to update user'); }
                });

                // Delete handler
                delBtn.addEventListener('click', async function(e){
                    e.stopPropagation();
                    if(!confirm('Delete this student?')) return;
                    try{
                        const res = await fetch('/admin/api/users/' + u.id, {method: 'DELETE'});
                        if(!res.ok) throw new Error('delete failed');
                        // remove row from DOM
                        row.remove();
                        // decrement total count if present
                        const ts = document.getElementById('totalStudentsValue');
                        if(ts && !isNaN(parseInt(ts.textContent))){
                            ts.textContent = Math.max(0, parseInt(ts.textContent) - 1);
                        }
                    }catch(err){ console.error('Failed to delete user', err); alert('Failed to delete user'); }
                });

                right.appendChild(editBtn);
                right.appendChild(delBtn);
                right.appendChild(role); right.appendChild(status);

                row.appendChild(left); row.appendChild(right);
                wrap.appendChild(row);
            });
            container.appendChild(wrap);
        }

        card.addEventListener('click', async function(){
            if(opened){ container.style.display = 'none'; opened = false; return; }
            container.style.display = 'block';
            container.innerHTML = '<div style="padding:18px;color:#9fb0c8">Loading students...</div>';
            const students = await fetchStudents();
            renderStudents(students);
            opened = true;
            // scroll into view smoothly
            container.scrollIntoView({behavior:'smooth'});
        });
    })();
</script>

    <script>
        // Expand/collapse pending requests list when clicking the Pending Requests stat
        (function(){
            const card = document.getElementById('pendingRequestsCard');
            const container = document.getElementById('pendingRequestsListContainer');
            if(!card || !container) return;
            let opened = false;
            async function fetchApplications(){
                try{
                    const res = await fetch('/admin/api/applications');
                    if(!res.ok) throw new Error('failed');
                    const items = await res.json();
                    return items || [];
                }catch(e){ console.error('Failed to fetch applications', e); return []; }
            }

            function renderApplications(list){
                container.innerHTML = '';
                if(!list || !list.length){
                    container.innerHTML = '<div style="padding:22px;color:#9fb0c8;background:transparent;border-radius:8px;text-align:center">No applications found</div>';
                    return;
                }
                const wrap = document.createElement('div');
                wrap.style.display = 'grid';
                wrap.style.gridTemplateColumns = '1fr';
                wrap.style.gap = '12px';
                list.forEach(it => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.padding = '12px 16px';
                    row.style.borderRadius = '8px';
                    row.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';

                    const left = document.createElement('div');
                    left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '12px'; left.style.flex = '1';
                    const avatar = document.createElement('div');
                    avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='10px'; avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center'; avatar.style.color='#fff'; avatar.style.fontWeight='800'; avatar.style.background='linear-gradient(90deg,#7c3aed,#2563eb)';
                    avatar.textContent = (it.studentName || it.studentEmail || 'S').charAt(0).toUpperCase();
                    const meta = document.createElement('div');
                    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.studentName || it.studentEmail || 'Student';
                    const sub = document.createElement('div'); sub.style.color='#9fb0c8'; sub.style.fontSize='0.95rem'; sub.textContent = (it.internshipTitle? it.internshipTitle : '') + (it.companyName ? (' ‚Ä¢ ' + it.companyName) : '');
                    meta.appendChild(title); if(sub.textContent) meta.appendChild(sub);
                    left.appendChild(avatar); left.appendChild(meta);

                    const right = document.createElement('div');
                    right.style.display='flex'; right.style.alignItems='center'; right.style.gap='12px';
                    const status = document.createElement('div'); status.textContent = it.status || 'PENDING'; status.style.padding='6px 12px'; status.style.borderRadius='999px'; status.style.background = it.status === 'APPROVED' ? '#dcfce7' : (it.status === 'REJECTED' ? '#fee2e2' : 'rgba(255,255,255,0.03)'); status.style.color = it.status === 'APPROVED' ? '#166534' : (it.status === 'REJECTED' ? '#991b1b' : '#cfe8ff'); status.style.fontWeight='700';
                    const applied = document.createElement('div'); applied.textContent = it.appliedAt ? new Date(it.appliedAt).toLocaleString() : '';
                    right.appendChild(applied); right.appendChild(status);

                    row.appendChild(left); row.appendChild(right);
                    wrap.appendChild(row);
                });
                container.appendChild(wrap);
            }

            card.addEventListener('click', async function(){
                if(opened){ container.style.display = 'none'; opened = false; return; }
                container.style.display = 'block';
                container.innerHTML = '<div style="padding:18px;color:#9fb0c8">Loading requests...</div>';
                const items = await fetchApplications();
                renderApplications(items);
                opened = true;
                container.scrollIntoView({behavior:'smooth'});
            });
        })();
    </script>

<script>
    // Expand/collapse companies list when clicking the Total Companies stat
    (function(){
        const card = document.getElementById('totalCompaniesCard');
        const container = document.getElementById('companiesListContainer');
        if(!card || !container) return;
        let opened = false;
        async function fetchCompanies(){
            try{
                const res = await fetch('/admin/api/companies');
                if(!res.ok) throw new Error('failed');
                const companies = await res.json();
                return companies || [];
            }catch(e){ console.error('Failed to fetch companies', e); return []; }
        }

        function renderCompanies(list){
            container.innerHTML = '';
            if(!list || !list.length){
                container.innerHTML = '<div style="padding:22px;color:#9fb0c8;background:transparent;border-radius:8px;text-align:center">No companies found</div>';
                return;
            }
            const wrap = document.createElement('div');
            wrap.style.display = 'grid';
            wrap.style.gridTemplateColumns = '1fr';
            wrap.style.gap = '12px';
            list.forEach(c => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '12px 16px';
                row.style.borderRadius = '8px';
                row.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '12px';
                const logo = document.createElement('div');
                logo.style.width='44px'; logo.style.height='44px'; logo.style.borderRadius='8px'; logo.style.display='flex'; logo.style.alignItems='center'; logo.style.justifyContent='center'; logo.style.color='#fff'; logo.style.fontWeight='800'; logo.style.background='linear-gradient(90deg,#0ea5e9,#2563eb)';
                logo.textContent = (c.companyName||'').charAt(0).toUpperCase();
                const meta = document.createElement('div');
                const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = c.companyName || '';
                const contact = document.createElement('div'); contact.style.color='#9fb0c8'; contact.style.fontSize='0.95rem'; contact.textContent = (c.contactEmail? c.contactEmail : '') + (c.contactPhone ? (' ‚Ä¢ ' + c.contactPhone) : '');
                const addr = document.createElement('div'); addr.style.color='#9fb0c8'; addr.style.fontSize='0.85rem'; addr.textContent = c.address || '';
                meta.appendChild(name); if(contact.textContent) meta.appendChild(contact); if(addr.textContent) meta.appendChild(addr);
                left.appendChild(logo); left.appendChild(meta);

                const right = document.createElement('div');
                right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'View';
                viewBtn.style.padding = '8px 12px';
                viewBtn.style.borderRadius = '8px';
                viewBtn.style.border = 'none';
                viewBtn.style.background = 'linear-gradient(90deg,#06b6d4,#3b82f6)';
                viewBtn.style.color = '#071226';
                viewBtn.style.cursor = 'pointer';
                viewBtn.addEventListener('click', function(){
                    // navigate to company profile page if exists
                    try{ window.location.href = '/admin/company/' + (c.id || ''); }catch(e){}
                });

                right.appendChild(viewBtn);
                row.appendChild(left); row.appendChild(right);
                wrap.appendChild(row);
            });
            container.appendChild(wrap);
        }

        card.addEventListener('click', async function(){
            if(opened){ container.style.display = 'none'; opened = false; return; }
            container.style.display = 'block';
            container.innerHTML = '<div style="padding:18px;color:#9fb0c8">Loading companies...</div>';
            const companies = await fetchCompanies();
            renderCompanies(companies);
            opened = true;
            container.scrollIntoView({behavior:'smooth'});
        });
    })();
</script>

<!-- Realtime role-specific notifications (students and companies) -->
<script>
    (function(){
        const badge = document.getElementById('liveLoginsBadge');
        const container = document.getElementById('liveLoginsContainer');
        const totalEl = document.getElementById('liveLoginsCount');
        const studentEl = document.getElementById('studentLoginsCount');
        const companyEl = document.getElementById('companyLoginsCount');
        if(!badge || !container || !totalEl || !studentEl || !companyEl) return;

        // map of currently-known active ids
        const prev = new Map();

        function makeToast(text, kind){
            const t = document.createElement('div');
            t.textContent = text;
            t.style.position='fixed'; t.style.right='18px'; t.style.top=(18 + (document.querySelectorAll('.__sims_toast').length||0)*62)+'px';
            t.style.background = kind === 'company' ? '#0ea5e9' : '#06b6d4';
            t.style.color='#071226'; t.style.padding='10px 14px'; t.style.borderRadius='8px'; t.style.boxShadow='0 10px 30px rgba(2,6,23,0.6)'; t.style.zIndex=2200; t.style.transition='opacity 0.5s';
            t.className = '__sims_toast';
            document.body.appendChild(t);
            setTimeout(()=> t.style.opacity='0', 3000);
            setTimeout(()=> t.remove(), 3600);
        }

        async function refresh(){
            try{
                const res = await fetch('/admin/api/active-users');
                if(!res.ok) return;
                const users = await res.json();
                const ids = new Set();
                let students = 0, companies = 0;
                (users||[]).forEach(u => {
                    ids.add(u.id);
                    const role = (u.role||'').toString().toUpperCase();
                    if(role === 'COMPANY') companies++; else students++;

                    if(!prev.has(u.id)){
                        // new login
                        if(role === 'COMPANY') makeToast('Company ' + (u.username||u.companyName||u.email||'Company') + ' logged in', 'company');
                        else makeToast('Student ' + (u.username||u.email||'User') + ' logged in', 'student');
                    }
                    prev.set(u.id, true);
                });

                // remove ids that no longer active
                for(const key of Array.from(prev.keys())){
                    if(!ids.has(key)) prev.delete(key);
                }

                // update counters and list
                totalEl.textContent = users ? users.length : 0;
                studentEl.textContent = students;
                companyEl.textContent = companies;

                // render list in container
                container.innerHTML = '';
                if(!users || users.length === 0){ container.innerHTML = '<div style="padding:12px;color:#9fb0c8">No active users</div>'; return; }
                users.forEach(u => {
                    const row = document.createElement('div');
                    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 6px'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
                    const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
                    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = u.username || u.email || 'Unknown';
                    const meta = document.createElement('div'); meta.style.color='#9fb0c8'; meta.style.fontSize='0.85rem'; meta.textContent = (u.role || '') + (u.email ? (' ‚Ä¢ ' + u.email) : '');
                    left.appendChild(title); left.appendChild(meta);
                    const right = document.createElement('div'); right.style.fontSize='0.85rem'; right.style.color='#cfe8ff'; right.textContent = u.createdAt ? new Date(u.createdAt).toLocaleTimeString() : '';
                    row.appendChild(left); row.appendChild(right); container.appendChild(row);
                });
            }catch(e){ console.error('refresh active users failed', e); }
        }

        // toggle list
        badge.addEventListener('click', ()=>{ container.style.display = container.style.display === 'block' ? 'none' : 'block'; });

        // SSE subscribe to server-sent events and refresh on events
        try{
            const es = new EventSource('/admin/stream/active-users');
            es.addEventListener('active-users', function(){ refresh(); });
            es.onopen = function(){ refresh(); };
            es.onerror = function(){ /* fallback polling will continue */ };
        }catch(e){ console.warn('SSE not available', e); }

        // initial + polling fallback
        refresh();
        setInterval(refresh, 20000);
    })();
</script>

<!-- Admin profile modal -->
<div id="adminProfileModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:3000;">
    <div style="background:#071226;padding:20px;border-radius:10px;width:420px;color:#cfe8ff;box-shadow:0 12px 36px rgba(2,6,23,0.6);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:1.05rem;font-weight:800;color:white">Admin Profile</div>
            <button id="closeAdminProfile" style="background:transparent;border:0;color:#9fb0c8;font-size:18px;cursor:pointer">‚úï</button>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
            <div id="modalAvatar" style="width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#6d28d9,#2563eb);color:#fff;font-weight:800;font-size:1.15rem">A</div>
            <div style="flex:1;">
                <div id="modalName" style="font-weight:800;font-size:1.05rem">Administrator</div>
                <div id="modalEmail" style="color:#9fb0c8;font-size:0.9rem">admin@example.com</div>
                <div id="modalRole" style="color:#9fb0c8;font-size:0.85rem;margin-top:6px">Role: ADMIN</div>
            </div>
        </div>

        <div style="margin-top:8px;">
            <label style="display:block;font-size:0.85rem;color:#9fb0c8;margin-bottom:6px">Display name</label>
            <input id="editAdminName" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#cfe8ff" />
        </div>

        <div style="margin-top:8px;">
            <label style="display:block;font-size:0.85rem;color:#9fb0c8;margin-bottom:6px">Email</label>
            <input id="editAdminEmail" type="email" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#cfe8ff" />
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
            <button id="saveAdminProfile" class="btn btn-primary btn-small">Save</button>
            <button id="cancelAdminProfile" class="btn btn-gray btn-small">Cancel</button>
        </div>
    </div>
</div>

<script>
    (function(){
        const badge = document.getElementById('adminProfile');
        const modal = document.getElementById('adminProfileModal');
        const closeBtn = document.getElementById('closeAdminProfile');
        const cancelBtn = document.getElementById('cancelAdminProfile');
        const saveBtn = document.getElementById('saveAdminProfile');
        const nameEl = document.getElementById('adminName');
        const avatarEl = document.getElementById('adminAvatar');
        const roleEl = document.getElementById('adminRole');
        const modalName = document.getElementById('modalName');
        const modalEmail = document.getElementById('modalEmail');
        const modalRole = document.getElementById('modalRole');
        const editName = document.getElementById('editAdminName');
        const editEmail = document.getElementById('editAdminEmail');
        const modalAvatar = document.getElementById('modalAvatar');

        if(!badge || !modal) return;

        let currentAdmin = null;

        // load admin info: pick first user with role ADMIN from /admin/api/users
        async function loadAdmin(){
            try{
                const res = await fetch('/admin/api/users');
                if(!res.ok) return;
                const users = await res.json();
                const admin = (users||[]).find(u => (u.role||'').toString().toUpperCase() === 'ADMIN');
                if(!admin) return;
                currentAdmin = admin;
                const display = admin.username || admin.email || 'Administrator';
                const initial = (display||'A').charAt(0).toUpperCase();
                if(nameEl) nameEl.textContent = display;
                if(avatarEl) avatarEl.textContent = initial;
                if(roleEl) roleEl.textContent = admin.role || 'ADMIN';
                if(modalName) modalName.textContent = display;
                if(modalEmail) modalEmail.textContent = admin.email || '';
                if(modalRole) modalRole.textContent = 'Role: ' + (admin.role || 'ADMIN');
                if(editName) editName.value = admin.username || '';
                if(editEmail) editEmail.value = admin.email || '';
                if(modalAvatar) modalAvatar.textContent = initial;
            }catch(e){ console.error('Failed to load admin', e); }
        }

        badge.addEventListener('click', function(){ modal.style.display = 'flex'; });
        closeBtn && closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
        cancelBtn && cancelBtn.addEventListener('click', function(){ modal.style.display = 'none'; });

        saveBtn && saveBtn.addEventListener('click', async function(){
            if(!currentAdmin) return alert('Admin not loaded');
            const newName = editName.value.trim();
            const newEmail = editEmail.value.trim();
            try{
                const res = await fetch('/admin/api/users/' + currentAdmin.id, {
                    method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: newName, email: newEmail})
                });
                if(!res.ok) throw new Error('update failed');
                const updated = await res.json();
                // update UI
                const display = updated.username || updated.email || 'Administrator';
                const initial = (display||'A').charAt(0).toUpperCase();
                nameEl && (nameEl.textContent = display);
                avatarEl && (avatarEl.textContent = initial);
                modalName && (modalName.textContent = display);
                modalEmail && (modalEmail.textContent = updated.email || '');
                modalAvatar && (modalAvatar.textContent = initial);
                modal.style.display = 'none';
            }catch(err){ console.error('Failed to update admin', err); alert('Failed to update profile'); }
        });

        // initial load
        loadAdmin();
    })();
</script>

</body>
</html>

